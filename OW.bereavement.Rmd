```{r}

```

---
title: "Outcome-wide analysis of bereavement during the COVID-19 pandemic"
author: "Koichiro Shiba and Ojasvi Pranav Vachharajani"
date: "1/12/2023"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, warning = FALSE,message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,message=FALSE,cashe = TRUE)
```

```{r}
library(tidyverse)
library(gtsummary)
library(mice)
#reset_gtsummary_theme()
#theme_gtsummary_journal(journal = "lancet")
#theme_gtsummary_compact(set_theme = F)
#options(gtsummary.tbl_summary.percent_fun = function(x) style_number(x * 100, digits = 1))
df.original <- haven::read_dta("C:\\Shiba\\Covid19_Data_30Nov2020.dta")
```

# Data Overview/Sample selection

-   Analysis1: Short-term effect during the lockdown

    -   Covariates (Week 1)

    -   Exposure (Week 3-6)

    -   Outcome (Week 7)

-   Analysis2: Short-term effect post-lockdown

    -   Covariates (Week 16)

    -   Exposure (Week 18-21)

    -   Outcome (Week 22)

-   Analysis3: Medium-term effect

    -   Covariates (Week 1)

    -   Exposure (Week 3-6)

    -   Outcome (Week 15)

```{r}
# create variables
df = df.original %>% 
  mutate(stressorsminor = rowSums(select(., stressorsminor___1:stressorsminor___16)),
         stressorsmajor = rowSums(select(., stressorsmajor___1:stressorsmajor___16)),
         volunteer = ifelse(acta8 == 0,"No","Yes"),
         caring = ifelse(acta7 == 0, "No","Yes"),
         socdistance = ifelse(socdist %in% c(0,1,2),"Yes","No"),
         socisolation = as.numeric(followingisolation),         
         smoking     = ifelse(smokechange == 3,"More than usual","As usual or less/don't smoke"),
         drinking    = ifelse(alcoholchange == 3, "More than usual", "As usual or less/don't drink"),
         diet        = ifelse(dietchange_3 == 1, "Less healthy than usual","As usual or more healthy"),
         self.harm   = ifelse(harm1 == 1, "Not at all","At least one day"),
         pa.1        = ifelse(actb3 == 0, "No","Yes"),
         pa.2        = ifelse(actb4 == 0, "No","Yes"),
         pa.3        = ifelse(actb6 == 0, "No","Yes"),         
         sleep.bin       = ifelse(sleep %in% c(1,2),"Good Sleep","Average or Poor Sleep")
  ) %>% 
  mutate_at(vars(onssat,onshappy,onsworth,socisolation),as.numeric) %>% 
  mutate_at(vars(smoking, drinking, diet, self.harm, sleep.bin,pa.1,pa.2,pa.3),as.factor)


df <- df %>% 
  mutate(illness = rowSums(select(., contains("illness___")))) %>% 
  mutate(illness = ifelse(illness___11 == 1,0,illness)) %>% 
  mutate(edu = factor(edu,labels = c("GCSE or below","A levels or equivalent","Degree of above")),
         lowincome = factor(lowincome, labels = c("≥£30 000","<£30 000")),
         socfreq.three = ifelse(socfreq == 1, "Every day",ifelse(socfreq %in% c(2,3),"Once a week or more often","Less than once a week"))) %>% 
  mutate(Service.attendance.category = ifelse(religattend <= 2, "At least once a week", ifelse(religattend <= 4, "Less than once a week","Not at all")),
         Service.attendance.category = factor(Service.attendance.category)) %>% 
  mutate(current.smoking = ifelse(smoker == 1, "Non-smoker",ifelse(smoker == 2, "Ex-smoker","Current smoker")))

df.relig <- df %>% filter(week %in% c(14,15)) %>% select(record_id, Service.attendance.category) %>% filter(complete.cases(.))

#df.relig <- df %>% filter(week %in% c(14,15)) %>% select(record_id, Service.attendance.category) %>% filter(complete.cases(.))
#ids.relig <- df.relig %>% unique() %>% pull(record_id)

# participate in week 1.
## n=28847
ids.week1 = df %>% filter(week == 1) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week1)

# participate in week 7.
## n=14155
ids.week7 = df %>% filter(week == 7) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week7)


# participate in week 15.
## n=10117
ids.week15 = df %>% filter(week == 15) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week15)


# identify exposed
## n=10117
## Participate in at least one wave between week 3 and week 6
## Note: think about potential misclassification: some "unexposed" individuals may have experienced loss in the weeks they did not participate in the survey. This will most likely attenuate the association
ids.lockdown = df %>% 
  filter(week %in% c(3,4,5,6)) %>% 
  select(record_id) %>% unique() %>% pull(record_id)

df = df %>% 
  filter(record_id %in% ids.lockdown)

df.exposure =
  df %>% 
  filter(week %in% c(3,4,5,6)) %>% 
  group_by(record_id) %>% 
  mutate(loss.pandemic = ifelse(sum(adverse___8,na.rm = T) != 0, 1, 0)) %>% #The na.rm = T argument tells R to remove (na.rm) any NA (missing) values before performing the sum. 
  ungroup() %>% 
  select(record_id,loss.pandemic) %>% 
  distinct()

df = df %>% 
  left_join(df.exposure) 


# No loss in the first two weeks.
## n=138
## n=9979 after exclusion
ids.preexposed = 
  df %>% 
  filter(week %in% c(1,2)) %>% 
  mutate(preexposed = ifelse(adverse___8 == 1,1,0)) %>% 
  filter(preexposed == 1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)

df = df %>% filter(!(record_id %in% ids.preexposed))


# No loss in the past year before the pandemic
## n=8051
ids.lossprioryear = df %>% 
  filter(lifeevent2 !=1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)
  
df = df %>% 
  mutate(loss.prioryear = ifelse(record_id %in% ids.lossprioryear,1,0),
         exclude.flag = ifelse(loss.pandemic == 1,0,ifelse(loss.prioryear == 1,1,0))) %>% 
  filter(exclude.flag == 0) 

#######################################################################
# # Participated every week from week 3-week7
# ## n=9556
# ids.short.effect = 
#   df %>% 
#   filter(week >=3 & week <=7) %>% 
#   group_by(record_id) %>% 
#   summarise(n=n()) %>% 
#   filter(n == 5) %>% 
#   pull(record_id)
# 
# df = df %>% filter(record_id %in% ids.short.effect)
# 
# # No loss in the first two weeks.
# ## n=118
# ## n=9438 after exclusion
# ids.preexposed = 
#   df %>% 
#   filter(week %in% c(1,2)) %>% 
#   mutate(preexposed = ifelse(adverse___8 == 1,1,0)) %>% 
#   filter(preexposed == 1) %>% 
#   select(record_id) %>% 
#   distinct() %>% 
#   pull(record_id)
# 
# df = df %>% filter(!(record_id %in% ids.preexposed))
# 
# # exposure variable
# df.exposure = df %>% 
#   filter(week <=6, week >= 3) %>% 
#   select(record_id, week, adverse___8) %>% 
#   group_by(record_id) %>% 
#   mutate(loss.pandemic = ifelse(sum(adverse___8,na.rm=T)!=0,1,0)) %>% 
#   ungroup() %>% 
#   select(record_id,loss.pandemic) %>% 
#   distinct()
# 
# df = df %>% 
#   left_join(df.exposure) 
# 
# # No loss in the past year before the pandemic
# ## n-7849
# ids.lossprioryear = df %>% 
#   filter(lifeevent2 !=1) %>% 
#   select(record_id) %>% 
#   distinct() %>% 
#   pull(record_id)
#   
# df = df %>% 
#   mutate(loss.prioryear = ifelse(record_id %in% ids.lossprioryear,1,0),
#          exclude.flag = ifelse(loss.pandemic == 1,0,ifelse(loss.prioryear == 1,1,0))) %>% 
#   filter(exclude.flag == 0) 
```

## Outcome Distribution

```{r}
# create weights
library(anesrake)
df.wgt <- df %>% filter(week == 1) %>% select(record_id,female,country,agegrp4,nonwhite,edu) %>% 
  mutate_at(vars(female,country,agegrp4,nonwhite,edu),as.integer) %>%
  mutate_at(vars(female,nonwhite), function(x) x + 1) %>% 
  as.data.frame() 

df.wgt$caseid <- 1:nrow(df.wgt)

female.target   <- c(0.494,0.506)
country.target  <- c(0.843, 0.047, 0.082, 0.028)
agegrp4.target  <- c(0.195, 0.261, 0.241,0.303)
nonwhite.target <- c(0.872,0.128)
edu.target      <- c(0.327,0.339,0.334)

targets <- list(female.target,country.target,agegrp4.target,nonwhite.target,edu.target)
names(targets) <- c("female","country","agegrp4","nonwhite","edu")

raked.output <- anesrake(targets, df.wgt, caseid = df.wgt$caseid)

df.wgt$wgt <- raked.output$weightvec
df.wgt <- df.wgt %>% select(record_id,wgt)

rm(df.temp)
```

```{r}
svy.df.week7 <- df %>% 
  filter(week == 7) %>% 
  left_join(df.wgt)

svy.df.week7 <- 
  survey::svydesign(
    id  = ~record_id,
    weights = ~wgt,
    data = svy.df.week7
  )

svy.df.week7 %>% 
  tbl_svysummary(
    include = c(onssat, onshappy, onsworth,support, lonely,volunteer,caring,socisolation,PHQ, GAD, stressorsminor, stressorsmajor,self.harm,smoking, drinking, diet, pa.1,pa.2,pa.3,sleep.bin,loss.pandemic),
    by = loss.pandemic,
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing_text = "(Missing)",
    label = list(stressorsmajor ~ "Stress major", 
                 stressorsminor ~ "Stress minor",
                 onssat ~ "Satisfaction with life",
                 onshappy ~ "Happiness",
                 onsworth ~ "Meaning",
                 volunteer ~ "Volunteering",
                 caring ~ "Caring",
                 socisolation ~ "Compliance with social isolation",
                 smoking ~ "No unhealthy smoking change",
                 drinking ~ "No unhealthy drinking change",
                 diet ~ "No unhealthy diet change",
                 self.harm ~ "Self-harm ideation",
                 pa.1 ~ "Gentle physical activity",
                 pa.2 ~ "High intensity physical activity",
                 pa.3 ~ "Exercising at home",
                 sleep.bin ~ "Good Sleep"
                 ),
    type = list(lonely~ "continuous",socisolation ~ "continuous",
                sleep.bin ~ "dichotomous",drinking ~ "dichotomous", smoking ~ "dichotomous"),
    value = list(sleep.bin ~ "Good Sleep",smoking ~ "As usual or less/don't smoke", drinking ~ "As usual or less/don't drink",diet ~ "As usual or more healthy",self.harm ~ "At least one day"),
    missing = "no"
    ) %>% 
  bold_labels() %>% 
  modify_header(
    update = list(label ~ "**Outcome at Week 7**")
  ) %>% 
  add_p() %>% 
  add_overall() %>% 
  modify_spanning_header(starts_with("stat_") ~ "**Bereavement during the lockdown**")
```

## Table 1: pre-baseline characteristics

```{r}
# weighted
svy.df <- df %>% 
  filter(week == 1) %>% 
  select(-Service.attendance.category) %>% 
  left_join(df.relig) %>%
  left_join(df.wgt) %>% 
  mutate_at(vars(closefriends,alcohol),as.numeric) %>% 
  select(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat,onsworth,support,lonely,volunteer,caring,socisolation,PHQ, GAD, stressorsminor, stressorsmajor,current.smoking,alcohol,smoking, drinking, pa.1,pa.2,pa.3,sleep.bin,record_id,wgt)

svy.df <- 
  survey::svydesign(
    id  = ~record_id,
    weights = ~wgt,
    data = svy.df
  )

svy.df %>% 
  tbl_svysummary(
    by = loss.pandemic,
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing_text = "(Missing)",
    include = c(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat,onsworth,support,lonely,volunteer,caring,socisolation,PHQ, GAD, stressorsminor, stressorsmajor,current.smoking,alcohol,smoking, drinking, pa.1,pa.2,pa.3,sleep.bin),
    label = list(
      Service.attendance.category ~ "Pre-pandemic Service Attendance",
      age ~ "Age",
      female ~ "Female Gender",
      nonwhite ~ "Non-white Ethnicity",
      edu ~ "Education",
      lowincome ~ "Low Income (<£30 000)",
      illness ~ "Number of health conditions",
      socfreq.three ~ "Frequency of meeting up with people in usual life",
      closefriends ~ "Number of close friends",
      current.smoking ~ "Smoking status",
      alcohol ~ "Number of alcoholic drinks in the past week",
      stressorsmajor ~ "Stress major",
      stressorsminor ~ "Stress minor",
      onssat ~ "Satisfaction with life",
      onsworth ~ "Meaning",
      volunteer ~ "Volunteering",
      caring ~ "Caring",
      socisolation ~ "Compliance with social isolation",
      smoking ~ "No unhealthy smoking change",
      drinking ~ "No unhealthy drinking change",
      pa.1 ~ "Gentle physical activity",
      pa.2 ~ "High intensity physical activity",
      pa.3 ~ "Exercising at home",      
      sleep.bin ~ "Good Sleep"
    ),
     type = list(lonely~ "continuous",illness ~ "continuous",socisolation ~ "continuous",
                sleep.bin ~ "dichotomous",drinking ~ "dichotomous", smoking ~ "dichotomous",lowincome ~ "dichotomous"),
    value = list(sleep.bin ~ "Good Sleep",smoking ~ "As usual or less/don't smoke", drinking ~ "As usual or less/don't drink", lowincome ~ "<£30 000"),
    missing = "no"   
  ) %>% 
  bold_labels() %>% 
  add_overall() %>% 
  modify_header(
    update = list(label ~ "**Pre-baseline Characteristis**")
  ) %>% 
  modify_spanning_header(starts_with("stat_") ~ "**Bereavement during the lockdown**") 
```

```         
```

# Create wide data

## Wide data for short-term effect

```{r}
# Create wide data
df.wide.outcomes <- df %>% 
  filter(week %in% c(1,7)) %>% 
  select(record_id,week,PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3) %>% 
  mutate(smoking     = ifelse(smoking     == "As usual or less/don't smoke",1,0),
         drinking    = ifelse(drinking    == "As usual or less/don't drink",1,0),
         diet        = ifelse(diet        == "As usual or more healthy",1,0),
         self.harm   = ifelse(self.harm   == "Not at all",0,1),
         sleep.bin   = ifelse(sleep.bin   == "Good Sleep",1,0),
         volunteer   = ifelse(volunteer   == "Yes",1,0),
         caring      = ifelse(caring      == "Yes",1,0),
         pa.1      = ifelse(pa.1      == "Yes",1,0),
         pa.2      = ifelse(pa.2      == "Yes",1,0),
         pa.3      = ifelse(pa.3      == "Yes",1,0)) %>% 
  distinct_at(vars(record_id,week),.keep_all = TRUE) 

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm) # standardize continuous outcomes

df.wide.outcomes <- df.wide.outcomes %>%
  mutate_at(vars(PHQ,GAD,stressorsminor,stressorsmajor,onssat,onshappy,onsworth,support,lonely,socisolation),scale2) %>% # standardize continuous outcomes
  pivot_wider(
      names_from = week,
      values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3)
      )

df.wide.cov <-  df %>% 
  filter(week == 1) %>% 
  select(-Service.attendance.category) %>% 
  left_join(df.relig) %>%
  select(record_id,loss.pandemic, age, female,nonwhite, alone, edu,employed,keyworker,lowincome,illness,Service.attendance.category,current.smoking,alcohol,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c) %>% 
  mutate_if(is.character,as.factor)

df.wide <- df.wide.outcomes %>% 
  left_join(df.wide.cov) %>% 
  left_join(df.wgt)

```

## Wide data for post-lockdown period

```{r}
# create variables
df = df.original %>% 
  mutate(stressorsminor = rowSums(select(., stressorsminor___1:stressorsminor___16)),
         stressorsmajor = rowSums(select(., stressorsmajor___1:stressorsmajor___16)),
         volunteer = ifelse(acta8 == 0,"No","Yes"),
         caring = ifelse(acta7 == 0, "No","Yes"),
         socdistance = ifelse(socdist %in% c(0,1,2),"Yes","No"),
         socisolation = as.numeric(followingisolation),         
         smoking     = ifelse(smokechange == 3,"More than usual","As usual or less/don't smoke"),
         drinking    = ifelse(alcoholchange == 3, "More than usual", "As usual or less/don't drink"),
         diet        = ifelse(dietchange_3 == 1, "Less healthy than usual","As usual or more healthy"),
         self.harm   = ifelse(harm1 == 1, "Not at all","At least one day"),
         pa.1        = ifelse(actb3 == 0, "No","Yes"),
         pa.2        = ifelse(actb4 == 0, "No","Yes"),
         pa.3        = ifelse(actb6 == 0, "No","Yes"),         
         sleep.bin       = ifelse(sleep %in% c(1,2),"Good Sleep","Average or Poor Sleep")
  ) %>% 
  mutate_at(vars(onssat,onshappy,onsworth,socisolation),as.numeric) %>% 
  mutate_at(vars(smoking, drinking, diet, self.harm, sleep.bin,pa.1,pa.2,pa.3),as.factor)


df <- df %>% 
  mutate(illness = rowSums(select(., contains("illness___")))) %>% 
  mutate(illness = ifelse(illness___11 == 1,0,illness)) %>% 
  mutate(edu = factor(edu,labels = c("GCSE or below","A levels or equivalent","Degree of above")),
         lowincome = factor(lowincome, labels = c("≥£30 000","<£30 000")),
         socfreq.three = ifelse(socfreq == 1, "Every day",ifelse(socfreq %in% c(2,3),"Once a week or more often","Less than once a week"))) %>% 
  mutate(Service.attendance.category = ifelse(religattend <= 2, "At least once a week", ifelse(religattend <= 4, "Less than once a week","Not at all")),
         Service.attendance.category = factor(Service.attendance.category)) %>% 
  mutate(current.smoking = ifelse(smoker == 1, "Non-smoker",ifelse(smoker == 2, "Ex-smoker","Current smoker")))


# participate in week 6.
## n=27552
ids.week16 = df %>% filter(week == 16) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week16)


# participate in week 22.
## n=20853
ids.week22 = df %>% filter(week == 22) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week22)


# identify exposed
## Participate in at least one wave between week 18 and week 21
### n=20851
## Note: think about potential misclassification: some "unexposed" individuals may have experienced loss in the weeks they did not participate in the survey. This will most likely attenuate the association
ids.postlockdown = df %>% 
  filter(week %in% c(18,19,20,21)) %>% 
  select(record_id) %>% unique() %>% pull(record_id)

df = df %>% 
  filter(record_id %in% ids.postlockdown)


df.exposure =
  df %>% 
  filter(week %in% c(18,19,20,21)) %>% 
  group_by(record_id) %>% 
  mutate(loss.nonpandemic = ifelse(sum(adverse___8,na.rm = T) != 0, 1, 0)) %>% 
  ungroup() %>% 
  select(record_id,loss.nonpandemic) %>% 
  distinct()

df = df %>% 
  left_join(df.exposure) 


# No loss before.
## n=2929
## n=17922 after exclusion
ids.preexposed = 
  df %>% 
  filter(week %in% c(1:17)) %>% 
  mutate(preexposed = ifelse(adverse___8 == 1,1,0)) %>% 
  filter(preexposed == 1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)

df = df %>% filter(!(record_id %in% ids.preexposed))

# No loss in the past year before the pandemic
## n=3558
## n=14456
ids.lossprioryear = df %>% 
  filter(lifeevent2 !=1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)
  
df = df %>% 
  mutate(loss.prioryear = ifelse(record_id %in% ids.lossprioryear,1,0),
         exclude.flag = ifelse(loss.nonpandemic == 1,0,ifelse(loss.prioryear == 1,1,0))) %>% 
  filter(exclude.flag == 0) 

# create wide data
df.wide.outcomes <- df %>% 
  filter(week %in% c(16,22)) %>% 
  select(record_id,week,PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3) %>% 
  mutate(smoking     = ifelse(smoking     == "As usual or less/don't smoke",1,0),
         drinking    = ifelse(drinking    == "As usual or less/don't drink",1,0),
         diet        = ifelse(diet        == "As usual or more healthy",1,0),
         self.harm   = ifelse(self.harm   == "Not at all",0,1),
         sleep.bin   = ifelse(sleep.bin   == "Good Sleep",1,0),
         volunteer   = ifelse(volunteer   == "Yes",1,0),
         caring      = ifelse(caring      == "Yes",1,0),
         pa.1      = ifelse(pa.1      == "Yes",1,0),
         pa.2      = ifelse(pa.2      == "Yes",1,0),
         pa.3      = ifelse(pa.3      == "Yes",1,0)) %>% 
  distinct_at(vars(record_id,week),.keep_all = TRUE) 

df.wide.outcomes <- df.wide.outcomes %>%
  mutate_at(vars(PHQ,GAD,stressorsminor,stressorsmajor,onssat,onshappy,onsworth,support,lonely,socisolation),scale2) %>% # standardize continuous outcomes
  mutate(week = ifelse(week == 16, 1, 7)) %>% 
  pivot_wider(
      names_from = week,
      values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3)
      )

df.wide.cov <-  df %>% 
  filter(week == 16) %>% 
  select(-Service.attendance.category) %>% 
  left_join(df.relig) %>%
  select(record_id,loss.nonpandemic, age, female,nonwhite, alone, edu,employed,keyworker,lowincome,illness,Service.attendance.category,current.smoking,alcohol,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c) %>% 
  mutate_if(is.character,as.factor)


df.wgt <- df %>% filter(week == 16) %>% select(record_id,female,country,agegrp4,nonwhite,edu) %>% 
  mutate_at(vars(female,country,agegrp4,nonwhite,edu),as.integer) %>%
  mutate_at(vars(female,nonwhite), function(x) x + 1) %>% 
  as.data.frame() 

df.wgt$caseid <- 1:nrow(df.wgt)
raked.output <- anesrake(targets, df.wgt, caseid = df.wgt$caseid)
df.wgt$wgt <- raked.output$weightvec
df.wgt <- df.wgt %>% select(record_id,wgt)


df.wide2 <- df.wide.outcomes %>% 
  left_join(df.wide.cov) %>% 
  left_join(df.wgt)
```

## Wide data for mid-term effects

```{r}
# create variables
df = df.original %>% 
  mutate(stressorsminor = rowSums(select(., stressorsminor___1:stressorsminor___16)),
         stressorsmajor = rowSums(select(., stressorsmajor___1:stressorsmajor___16)),
         volunteer = ifelse(acta8 == 0,"No","Yes"),
         caring = ifelse(acta7 == 0, "No","Yes"),
         socdistance = ifelse(socdist %in% c(0,1,2),"Yes","No"),
         socisolation = as.numeric(followingisolation),         
         smoking     = ifelse(smokechange == 3,"More than usual","As usual or less/don't smoke"),
         drinking    = ifelse(alcoholchange == 3, "More than usual", "As usual or less/don't drink"),
         diet        = ifelse(dietchange_3 == 1, "Less healthy than usual","As usual or more healthy"),
         self.harm   = ifelse(harm1 == 1, "Not at all","At least one day"),
         pa.1        = ifelse(actb3 == 0, "No","Yes"),
         pa.2        = ifelse(actb4 == 0, "No","Yes"),
         pa.3        = ifelse(actb6 == 0, "No","Yes"),         
         sleep.bin       = ifelse(sleep %in% c(1,2),"Good Sleep","Average or Poor Sleep")
  ) %>% 
  mutate_at(vars(onssat,onshappy,onsworth,socisolation),as.numeric) %>% 
  mutate_at(vars(smoking, drinking, diet, self.harm, sleep.bin,pa.1,pa.2,pa.3),as.factor)


df <- df %>% 
  mutate(illness = rowSums(select(., contains("illness___")))) %>% 
  mutate(illness = ifelse(illness___11 == 1,0,illness)) %>% 
  mutate(edu = factor(edu,labels = c("GCSE or below","A levels or equivalent","Degree of above")),
         lowincome = factor(lowincome, labels = c("≥£30 000","<£30 000")),
         socfreq.three = ifelse(socfreq == 1, "Every day",ifelse(socfreq %in% c(2,3),"Once a week or more often","Less than once a week"))) %>% 
  mutate(Service.attendance.category = ifelse(religattend <= 2, "At least once a week", ifelse(religattend <= 4, "Less than once a week","Not at all")),
         Service.attendance.category = factor(Service.attendance.category)) %>% 
  mutate(current.smoking = ifelse(smoker == 1, "Non-smoker",ifelse(smoker == 2, "Ex-smoker","Current smoker")))


# participate in week 1.
## n=28847
ids.week1 = df %>% filter(week == 1) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week1)

# participate in week 15.
## n=11330
ids.week15 = df %>% filter(week == 15) %>% select(record_id) %>% unique() %>% pull(record_id)
df = df %>% 
  filter(record_id %in% ids.week15)


# identify exposed
## n=11329
## Participate in at least one wave between week 3 and week 6
## Note: think about potential misclassification: some "unexposed" individuals may have experienced loss in the weeks they did not participate in the survey. This will most likely attenuate the association
ids.lockdown = df %>% 
  filter(week %in% c(3,4,5,6)) %>% 
  select(record_id) %>% unique() %>% pull(record_id)


df.exposure =
  df %>% 
  filter(week %in% c(3,4,5,6)) %>% 
  group_by(record_id) %>% 
  mutate(loss.pandemic = ifelse(sum(adverse___8,na.rm = T) != 0, 1, 0)) %>% 
  ungroup() %>% 
  select(record_id,loss.pandemic) %>% 
  distinct()

df = df %>% 
  left_join(df.exposure) 


# No loss in the first two weeks.
## n=156
## n=11174 after exclusion
ids.preexposed = 
  df %>% 
  filter(week %in% c(1,2)) %>% 
  mutate(preexposed = ifelse(adverse___8 == 1,1,0)) %>% 
  filter(preexposed == 1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)

df = df %>% filter(!(record_id %in% ids.preexposed))


# No loss in the past year before the pandemic
## n=9042
ids.lossprioryear = df %>% 
  filter(lifeevent2 !=1) %>% 
  select(record_id) %>% 
  distinct() %>% 
  pull(record_id)
  
df = df %>% 
  mutate(loss.prioryear = ifelse(record_id %in% ids.lossprioryear,1,0),
         exclude.flag = ifelse(loss.pandemic == 1,0,ifelse(loss.prioryear == 1,1,0))) %>% 
  filter(exclude.flag == 0) 

# participate in week 7.
## n=14155
ids.week7 = df %>% filter(week == 7) %>% select(record_id) %>% unique() %>% pull(record_id)

df = df %>% 
  filter(record_id %in% ids.week7)

# create wide data
df.wide.outcomes <- df %>% 
  filter(week %in% c(1,15)) %>% 
  select(record_id,week,PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3) %>% 
  mutate(smoking     = ifelse(smoking     == "As usual or less/don't smoke",1,0),
         drinking    = ifelse(drinking    == "As usual or less/don't drink",1,0),
         diet        = ifelse(diet        == "As usual or more healthy",1,0),
         self.harm   = ifelse(self.harm   == "Not at all",0,1),
         sleep.bin   = ifelse(sleep.bin   == "Good Sleep",1,0),
         volunteer   = ifelse(volunteer   == "Yes",1,0),
         caring      = ifelse(caring      == "Yes",1,0),
         pa.1      = ifelse(pa.1      == "Yes",1,0),
         pa.2      = ifelse(pa.2      == "Yes",1,0),
         pa.3      = ifelse(pa.3      == "Yes",1,0)) %>% 
  distinct_at(vars(record_id,week),.keep_all = TRUE) 

df.wide.outcomes <- df.wide.outcomes %>%
  mutate_at(vars(PHQ,GAD,stressorsminor,stressorsmajor,onssat,onshappy,onsworth,support,lonely,socisolation),scale2) %>% # standardize continuous outcomes
  mutate(week = ifelse(week == 15, 7, 1)) %>% 
  pivot_wider(
      names_from = week,
      values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely,  smoking, drinking, diet, self.harm,sleep.bin,socisolation,volunteer,caring,pa.1,pa.2,pa.3)
      )

df.wide.cov <-  df %>% 
  filter(week == 1) %>% 
  select(-Service.attendance.category) %>% 
  left_join(df.relig) %>%
  select(record_id,loss.pandemic, age, female,nonwhite, alone, edu,employed,keyworker,lowincome,illness,Service.attendance.category,current.smoking,alcohol,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c) %>% 
  mutate_if(is.character,as.factor)

df.wgt <- df %>% filter(week == 1) %>% select(record_id,female,country,agegrp4,nonwhite,edu) %>% 
  mutate_at(vars(female,country,agegrp4,nonwhite,edu),as.integer) %>%
  mutate_at(vars(female,nonwhite), function(x) x + 1) %>% 
  as.data.frame() 

df.wgt$caseid <- 1:nrow(df.wgt)
raked.output <- anesrake(targets, df.wgt, caseid = df.wgt$caseid)
df.wgt$wgt <- raked.output$weightvec
df.wgt <- df.wgt %>% select(record_id,wgt)


df.wide3 <- df.wide.outcomes %>% 
  left_join(df.wide.cov)%>% 
  left_join(df.wgt)
```

```{r}
# Create pooled wide data
df.wide.combined = 
  rbind(
    df.wide %>% 
      mutate(lockdown = 1,
             short = 1,
             sample = 1),
    df.wide2 %>% 
      mutate(lockdown = 0,
             short = 1,
             sample = 2) %>% 
      rename(loss.pandemic = loss.nonpandemic),
    df.wide3 %>% 
      mutate(lockdown = 1,
             short = 0,
             sample = 3) 
  )

df.wide.combined %>% 
  arrange(record_id)
```

```{r}
# weighted
svy.df <- df.wide.combined %>% 
  filter(sample == 1) %>% 
  mutate_at(vars(closefriends,alcohol),as.numeric) %>% 
  select(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1,record_id,wgt)

svy.df <- 
  survey::svydesign(
    id  = ~record_id,
    weights = ~wgt,
    data = svy.df
  )

tbl1 = svy.df %>% 
  tbl_svysummary(
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing_text = "(Missing)",
    include = c(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1),
    label = list(
      Service.attendance.category ~ "Pre-pandemic Service Attendance",
      age ~ "Age",
      female ~ "Female Gender",
      nonwhite ~ "Non-white Ethnicity",
      edu ~ "Education",
      lowincome ~ "Low Income (<£30 000)",
      illness ~ "Number of health conditions",
      socfreq.three ~ "Frequency of meeting up with people in usual life",
      closefriends ~ "Number of close friends",
      current.smoking ~ "Smoking status",
      alcohol ~ "Number of alcoholic drinks in the past week",
      stressorsmajor_1 ~ "Stress major", 
      stressorsminor_1 ~ "Stress minor",
      onssat_1 ~ "Satisfaction with life",
      onsworth_1 ~ "Meaning",
      volunteer_1 ~ "Volunteering",
      caring_1 ~ "Caring",
      socisolation_1 ~ "Compliance with social isolation",
      smoking_1 ~ "No unhealthy smoking change",
      drinking_1 ~ "No unhealthy drinking change",
      pa.1_1 ~ "Gentle physical activity",
      pa.2_1 ~ "High intensity physical activity",
      pa.3_1 ~ "Exercising at home",      
      sleep.bin_1 ~ "Good Sleep"
    ),
     type = list(lonely_1~ "continuous",illness ~ "continuous",socisolation_1 ~ "continuous",
                sleep.bin_1 ~ "dichotomous",drinking_1 ~ "dichotomous", smoking_1 ~ "dichotomous",lowincome ~ "dichotomous"),
    value = list(sleep.bin_1 ~ "Good Sleep", lowincome ~ "<£30 000"),
    missing = "no"   
  ) %>% 
  bold_labels() %>% 
  modify_header(
    update = list(label ~ "**Pre-baseline Characteristis**")
  ) %>% 
  modify_spanning_header(starts_with("stat_") ~ "**Primary**")  

svy.df <- df.wide.combined %>% 
  filter(sample == 2) %>% 
  mutate_at(vars(closefriends,alcohol),as.numeric) %>% 
  select(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1,record_id,wgt)

svy.df <- 
  survey::svydesign(
    id  = ~record_id,
    weights = ~wgt,
    data = svy.df
  )

tbl2 = svy.df %>% 
  tbl_svysummary(
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing_text = "(Missing)",
    include = c(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1),
    label = list(
      Service.attendance.category ~ "Pre-pandemic Service Attendance",
      age ~ "Age",
      female ~ "Female Gender",
      nonwhite ~ "Non-white Ethnicity",
      edu ~ "Education",
      lowincome ~ "Low Income (<£30 000)",
      illness ~ "Number of health conditions",
      socfreq.three ~ "Frequency of meeting up with people in usual life",
      closefriends ~ "Number of close friends",
      current.smoking ~ "Smoking status",
      alcohol ~ "Number of alcoholic drinks in the past week",
      stressorsmajor_1 ~ "Stress major", 
      stressorsminor_1 ~ "Stress minor",
      onssat_1 ~ "Satisfaction with life",
      onsworth_1 ~ "Meaning",
      volunteer_1 ~ "Volunteering",
      caring_1 ~ "Caring",
      socisolation_1 ~ "Compliance with social isolation",
      smoking_1 ~ "No unhealthy smoking change",
      drinking_1 ~ "No unhealthy drinking change",
      pa.1_1 ~ "Gentle physical activity",
      pa.2_1 ~ "High intensity physical activity",
      pa.3_1 ~ "Exercising at home",      
      sleep.bin_1 ~ "Good Sleep"
    ),
     type = list(lonely_1~ "continuous",illness ~ "continuous",socisolation_1 ~ "continuous",
                sleep.bin_1 ~ "dichotomous",drinking_1 ~ "dichotomous", smoking_1 ~ "dichotomous",lowincome ~ "dichotomous"),
    value = list(sleep.bin_1 ~ "Good Sleep", lowincome ~ "<£30 000"),
    missing = "no"   
  ) %>% 
  bold_labels() %>% 
  modify_header(
    update = list(label ~ "**Pre-baseline Characteristis**")
  ) %>% 
  modify_spanning_header(starts_with("stat_") ~ "**Post-lockdown**")  


svy.df <- df.wide.combined %>% 
  filter(sample == 3) %>% 
  mutate_at(vars(closefriends,alcohol),as.numeric) %>% 
  select(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1,record_id,wgt)

svy.df <- 
  survey::svydesign(
    id  = ~record_id,
    weights = ~wgt,
    data = svy.df
  )

tbl3 = svy.df %>% 
  tbl_svysummary(
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing_text = "(Missing)",
    include = c(age,female,nonwhite,alone,edu,employed,keyworker,lowincome,illness,Service.attendance.category,socfreq.three,closefriends,BFI_n,BFI_e,BFI_o,BFI_a,BFI_c,loss.pandemic,onssat_1,onsworth_1,support_1,lonely_1,volunteer_1,caring_1,socisolation_1,PHQ_1, GAD_1, stressorsminor_1, stressorsmajor_1,current.smoking,alcohol,smoking_1, drinking_1, pa.1_1,pa.2_1,pa.3_1,sleep.bin_1),
    label = list(
      Service.attendance.category ~ "Pre-pandemic Service Attendance",
      age ~ "Age",
      female ~ "Female Gender",
      nonwhite ~ "Non-white Ethnicity",
      edu ~ "Education",
      lowincome ~ "Low Income (<£30 000)",
      illness ~ "Number of health conditions",
      socfreq.three ~ "Frequency of meeting up with people in usual life",
      closefriends ~ "Number of close friends",
      current.smoking ~ "Smoking status",
      alcohol ~ "Number of alcoholic drinks in the past week",
      stressorsmajor_1 ~ "Stress major", 
      stressorsminor_1 ~ "Stress minor",
      onssat_1 ~ "Satisfaction with life",
      onsworth_1 ~ "Meaning",
      volunteer_1 ~ "Volunteering",
      caring_1 ~ "Caring",
      socisolation_1 ~ "Compliance with social isolation",
      smoking_1 ~ "No unhealthy smoking change",
      drinking_1 ~ "No unhealthy drinking change",
      pa.1_1 ~ "Gentle physical activity",
      pa.2_1 ~ "High intensity physical activity",
      pa.3_1 ~ "Exercising at home",      
      sleep.bin_1 ~ "Good Sleep"
    ),
     type = list(lonely_1~ "continuous",illness ~ "continuous",socisolation_1 ~ "continuous",
                sleep.bin_1 ~ "dichotomous",drinking_1 ~ "dichotomous", smoking_1 ~ "dichotomous",lowincome ~ "dichotomous"),
    value = list(sleep.bin_1 ~ "Good Sleep", lowincome ~ "<£30 000"),
    missing = "no"   
  ) %>% 
  bold_labels() %>% 
  modify_header(
    update = list(label ~ "**Pre-baseline Characteristis**")
  ) %>% 
  modify_spanning_header(starts_with("stat_") ~ "**Mid-term**")  

tbl_merge(tbls = list(tbl1, tbl2, tbl3),
          tab_spanner = c("Primary","Post-lockdown","Mid-term"))
```

# Multiple imputation

First, let's check the number of missing data for each varaible. Pre-baseline happiness, self-harm, and diet were compeltely missing. Thus, we will not use these pre-baseline outcomes as covariates.

```{r}
miss.check <- df.wide.combined %>% 
  select(-record_id) %>% 
  summarise_all(funs(sum(is.na(.)))) %>%
  pivot_longer(
    everything(),
    names_to = "Variable",
    values_to = "n.miss"
  ) %>% 
  arrange(desc(n.miss))

#miss.check %>% 
  #knitr::kable() %>% 
   #kableExtra::kable_paper("hover",html_font = "serif",full_width = F)

vars.ordered <- miss.check %>% slice(-1,-2,-3) %>% select(Variable)
vars.ordered <- vars.ordered$Variable %>% as.vector()
```

We performed multiple imputation (m=5) to impute missing in covariates and outcomes. No missing in the exposure (isolation_new2: confinement from week 4).

```{r}
df.analytic <- df.wide.combined %>% 
  select(vars.ordered,record_id)

m <- 5
set.seed(123)
df.imputed <- df.analytic %>% mice(., m = m,pred = quickpred(., exclude = c("record_id")),print=FALSE)
df.imputed.long <- df.imputed %>% complete("long")


write.csv(df.imputed.long,"df.imputed.long.pooled3.csv")
df.imputed.long <- read.csv("df.imputed.long.pooled3.csv") %>% select(-X)
```

# Analysis 1

-   Short-term effect during the lockdown

    -   Covariates (Week 1)

    -   Exposure (Week 3-6)

    -   Outcome (Week 7)

```{r}
library(broom)
library(ltmle)

extract.estimates.ltmle <- function(model.output.TMLE){
  output.TMLE <- summary(model.output.TMLE)
  output.TMLE <- output.TMLE$effect.measures
  ATE.TMLE    <- output.TMLE$ATE %>% as.data.frame()
  return(ATE.TMLE)
}

extract.estimates.ltmle.binary <- function(model.output.TMLE){
  output.TMLE <- summary(model.output.TMLE)
  output.TMLE <- output.TMLE$effect.measures
  RR.TMLE     <- output.TMLE$RR %>% as.data.frame()
  return(RR.TMLE)
}


perform.TMLE <- function(outcome.name,sample.num){
  outcome <- paste(outcome.name, "_7",sep="")  # change week of outcome assessment if needed
  data = df.imputed.long %>% 
    filter(sample == sample.num) %>% 
    mutate(Yvar = (!!as.name(outcome)))
  
  output = data %>% 
    group_nest(.imp) %>% 
    mutate(data = map(data, function(x) x %>% select(PHQ_1, GAD_1, stressorsmajor_1, stressorsminor_1, onssat_1, onsworth_1, support_1, lonely_1, smoking_1, drinking_1, sleep.bin_1, volunteer_1, caring_1, pa.1_1, pa.2_1, pa.3_1, Service.attendance.category, age, female, nonwhite, alone , edu, employed, keyworker, lowincome, illness, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c,loss.pandemic,Yvar)),
           fit = map(data, function(x)  x %>%  ltmle(Anodes = "loss.pandemic",Ynodes = "Yvar",abar = list(1,0),observation.weights = x$wgt)),
           estimate = map(fit, function(x) extract.estimates.ltmle(x))) 

  output = output %>%
    select(.imp,estimate) %>% 
    unnest(estimate) %>% 
    mutate(variance = std.dev^2) %>% 
    summarise(estimate.combined = mean(estimate),
              Vw = sum(variance)/m,
              Vb = sum((estimate - mean(estimate))^2/(m-1)),
              Vt = Vw + (1 + 1/m)*Vb,
              SE.combined = sqrt(Vt),
              vm = (m-1)*(1 + (Vw/((1+1/m)*Vb)))^2,
              ci.low = estimate.combined - qt(0.975, vm)*SE.combined,
              ci.up = estimate.combined + qt(0.975, vm)*SE.combined,
              p.value = pt(-abs(estimate.combined/SE.combined),vm)*2
    ) %>% 
    mutate_if(is.numeric,round,3) %>% 
    mutate(outcome = outcome.name) %>% 
    select(outcome,estimate.combined,SE.combined, ci.low, ci.up, p.value)   
  
  return(output)
}


perform.TMLE.binary <- function(outcome.name,sample.num){
  outcome <- paste(outcome.name, "_7",sep="")  # change week of outcome assessment if needed
  data = df.imputed.long %>% 
    filter(sample == sample.num) %>% 
    mutate(Yvar = (!!as.name(outcome)))
  
  output = data %>% 
    group_nest(.imp) %>% 
    mutate(data = map(data, function(x) x %>% select(PHQ_1, GAD_1, stressorsmajor_1, stressorsminor_1, onssat_1, onsworth_1, support_1, lonely_1, smoking_1, drinking_1, sleep.bin_1, volunteer_1, caring_1, pa.1_1, pa.2_1, pa.3_1, Service.attendance.category, age, female, nonwhite, alone , edu, employed, keyworker, lowincome, illness, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c,loss.pandemic,Yvar)),
           fit = map(data, function(x)  x %>%  ltmle(Anodes = "loss.pandemic",Ynodes = "Yvar",abar = list(1,0),observation.weights = x$wgt)),
           estimate = map(fit, function(x) extract.estimates.ltmle.binary(x))) 

  output = output %>%
    select(.imp,estimate) %>% 
    unnest(estimate) %>% 
    mutate(variance = std.dev^2) %>% 
    summarise(estimate.combined = mean(estimate),
              Vw = sum(variance)/m,
              Vb = sum((log(estimate) - mean(log(estimate)))^2/(m-1)),
              Vt = Vw + (1 + 1/m)*Vb,
              SE.combined = sqrt(Vt),
              vm = (m-1)*(1 + (Vw/((1+1/m)*Vb)))^2,
              ci.low = exp(log(estimate.combined) - qt(0.975, vm)*SE.combined),
              ci.up = exp(log(estimate.combined) + qt(0.975, vm)*SE.combined),
              p.value = pt(-abs(log(estimate.combined)/SE.combined),vm)*2
    ) %>% 
    mutate_if(is.numeric,round,4) %>% 
    mutate(outcome = outcome.name) %>% 
    select(outcome,estimate.combined,SE.combined, ci.low, ci.up, p.value)   
  
  return(output)
}
```

```{r}
output.long <- rbind(
  perform.TMLE(outcome = "onssat",1),
  perform.TMLE(outcome = "onshappy",1),
  perform.TMLE(outcome = "onsworth",1),
  perform.TMLE(outcome = "support",1),
  perform.TMLE(outcome = "lonely",1),
  perform.TMLE.binary(outcome = "volunteer",1),
  perform.TMLE.binary(outcome = "caring",1),
  perform.TMLE(outcome = "socisolation",1),    
  perform.TMLE(outcome = "PHQ",1),
  perform.TMLE(outcome = "GAD",1),
  perform.TMLE(outcome = "stressorsminor",1),
  perform.TMLE(outcome = "stressorsmajor",1),  
  perform.TMLE.binary(outcome = "self.harm",1),
  perform.TMLE.binary(outcome = "smoking",1),
  perform.TMLE.binary(outcome = "drinking",1),
  perform.TMLE.binary(outcome = "diet",1),
  perform.TMLE.binary(outcome = "pa.1",1),
  perform.TMLE.binary(outcome = "pa.2",1),
  perform.TMLE.binary(outcome = "pa.3",1),  
  perform.TMLE.binary(outcome = "sleep.bin",1)
)

output.long.main <- output.long %>% 
  select(-SE.combined) %>% 
  mutate(sig = ifelse(p.value*20 < 0.05,"***",ifelse(p.value < 0.01, "**",ifelse(p.value <0.05, "*.","N.S."))))  

output.long.main %>% 
  rename(Outcome = outcome,
         Estimate = estimate.combined,
         CI.low = ci.low,
         CI.up  = ci.up) %>% 
  knitr::kable() %>% 
  kableExtra::kable_paper("hover",html_font = "serif",full_width = F)
```

# Analysis 2

-   Short-term effect post-lockdown

    -   Covariates (Week 16)

    -   Exposure (Week 18-21)

    -   Outcome (Week 22)

```{r}

output.long <- rbind(
  perform.TMLE(outcome = "onssat",2),
  perform.TMLE(outcome = "onshappy",2),
  perform.TMLE(outcome = "onsworth",2),
  perform.TMLE(outcome = "support",2),
  perform.TMLE(outcome = "lonely",2),
  perform.TMLE.binary(outcome = "volunteer",2),
  perform.TMLE.binary(outcome = "caring",2),
  perform.TMLE(outcome = "socisolation",2),    
  perform.TMLE(outcome = "PHQ",2),
  perform.TMLE(outcome = "GAD",2),
  perform.TMLE(outcome = "stressorsminor",2),
  perform.TMLE(outcome = "stressorsmajor",2),  
  perform.TMLE.binary(outcome = "self.harm",2),
  perform.TMLE.binary(outcome = "smoking",2),
  perform.TMLE.binary(outcome = "drinking",2),
  perform.TMLE.binary(outcome = "diet",2),
  perform.TMLE.binary(outcome = "pa.1",2),
  perform.TMLE.binary(outcome = "pa.2",2),
  perform.TMLE.binary(outcome = "pa.3",2),  
  perform.TMLE.binary(outcome = "sleep.bin",2)
)

output.long.postlockdown <- output.long %>% 
  select(-SE.combined) %>% 
  mutate(sig = ifelse(p.value*20 < 0.05,"***",ifelse(p.value < 0.01, "**",ifelse(p.value <0.05, "*.","N.S."))))  


output.long.postlockdown %>% 
  rename(Outcome = outcome,
         Estimate = estimate.combined,
         CI.low = ci.low,
         CI.up  = ci.up) %>% 
  knitr::kable() %>% 
  kableExtra::kable_paper("hover",html_font = "serif",full_width = F)
```

# Analysis 3

-   Medium-term effect

    -   Covariates (Week 1)

    -   Exposure (Week 3-6)

    -   Outcome (Week 15)

```{r}

output.long <- rbind(
  perform.TMLE(outcome = "onssat",3),
  perform.TMLE(outcome = "onshappy",3),
  perform.TMLE(outcome = "onsworth",3),
  perform.TMLE(outcome = "support",3),
  perform.TMLE(outcome = "lonely",3),
  perform.TMLE.binary(outcome = "volunteer",3),
  perform.TMLE.binary(outcome = "caring",3),
  perform.TMLE(outcome = "socisolation",3),    
  perform.TMLE(outcome = "PHQ",3),
  perform.TMLE(outcome = "GAD",3),
  perform.TMLE(outcome = "stressorsminor",3),
  perform.TMLE(outcome = "stressorsmajor",3),  
  perform.TMLE.binary(outcome = "self.harm",3),
  perform.TMLE.binary(outcome = "smoking",3),
  perform.TMLE.binary(outcome = "drinking",3),
  perform.TMLE.binary(outcome = "diet",3),
  perform.TMLE.binary(outcome = "pa.1",3),
  perform.TMLE.binary(outcome = "pa.2",3),
  perform.TMLE.binary(outcome = "pa.3",3),  
  perform.TMLE.binary(outcome = "sleep.bin",3)
)

output.long.midterm <- output.long %>% 
  select(-SE.combined) %>% 
  mutate(sig = ifelse(p.value*20 < 0.05,"***",ifelse(p.value < 0.01, "**",ifelse(p.value <0.05, "*.","N.S."))))  


output.long.midterm %>% 
  rename(Outcome = outcome,
         Estimate = estimate.combined,
         CI.low = ci.low,
         CI.up  = ci.up) %>% 
  knitr::kable() %>% 
  kableExtra::kable_paper("hover",html_font = "serif",full_width = F)
```

# Output

## Figure

```{r}

con.outcomes = c("onssat","onshappy","stressorsminor","stressorsmajor","support","socisolation","PHQ","onsworth","lonely","GAD")

rbind(
  output.long.main %>% mutate(analysis = "Primary"),
  output.long.midterm %>% mutate(analysis = "Mid-term"),
  output.long.postlockdown %>% mutate(analysis = "Post-lockdown")  
) %>% 
  mutate(analysis = factor(analysis,levels = c("Primary","Post-lockdown","Mid-term"))) %>% 
  filter(outcome %in% con.outcomes) %>% 
  ggplot(aes(x = outcome, y = estimate.combined, ymin = ci.low, ymax = ci.up, shape = analysis, color = analysis)) +
  geom_pointrange(position = position_dodge(-0.6)) +
  coord_flip() +
  ggsci::scale_color_nejm()+
  geom_hline(yintercept  = 0, linetype = "dotted") +
  theme_classic()



rbind(
  output.long.main %>% mutate(analysis = "Primary"),
  output.long.midterm %>% mutate(analysis = "Mid-term"),
  output.long.postlockdown %>% mutate(analysis = "Post-lockdown")  
) %>%
  mutate(analysis = factor(analysis,levels = c("Primary","Post-lockdown","Mid-term"))) %>% 
  filter(!(outcome %in% con.outcomes)) %>% 
  ggplot(aes(x = outcome, y = estimate.combined, ymin = ci.low, ymax = ci.up, shape = analysis, color = analysis)) +
  geom_pointrange(position = position_dodge(-0.6)) +
  coord_flip() +
  ggsci::scale_color_nejm()+
  geom_hline(yintercept  = 1, linetype = "dotted") +
  theme_classic()
```

```{r}
# Load required libraries
library(tidyverse)
library(survey)
library(anesrake)
library(mice)
library(ltmle)

# Define function to get unique participant IDs
get_unique_ids <- function(df, weeks) {
  df %>%
    filter(week %in% weeks) %>%
    select(record_id) %>%
    distinct() %>%
    pull(record_id)
}

# Unique IDs for all necessary waves
ids_week1 <- get_unique_ids(df.original, 1)
ids_week7 <- get_unique_ids(df.original, 7)
ids_week15 <- get_unique_ids(df.original, 15)
ids_week16 <- get_unique_ids(df.original, 16)
ids_week22 <- get_unique_ids(df.original, 22)
ids_weeks3_to_6 <- get_unique_ids(df.original, 3:6)
ids_weeks18_to_21 <- get_unique_ids(df.original, 18:21)

# Getting a consistent sample
consistent_sample_ids <- intersect(ids_week1, ids_week7)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week15)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week16)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week22)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks3_to_6)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks18_to_21)

# Getting the number of participants in the consistent sample
num_participants <- length(consistent_sample_ids)
cat("Number of participants in the consistent sample:", num_participants, "\n")
```

```{r}
# Load required libraries
library(tidyverse)
library(survey)
library(anesrake)
library(mice)
library(ltmle)
library(haven)

# Define function to get unique participant IDs for specified weeks
get_unique_ids <- function(df, weeks) {
  df %>%
    filter(week %in% weeks) %>%
    select(record_id) %>%
    distinct() %>%
    pull(record_id)
}

# Load the original data
df.original <- haven::read_dta("C:\\Shiba\\Covid19_Data_30Nov2020.dta")

# Get unique IDs for all necessary weeks
ids_week1 <- get_unique_ids(df.original, 1)
ids_week7 <- get_unique_ids(df.original, 7)
ids_week15 <- get_unique_ids(df.original, 15)
ids_week16 <- get_unique_ids(df.original, 16)
ids_week22 <- get_unique_ids(df.original, 22)
ids_weeks3_to_6 <- get_unique_ids(df.original, 3:6)
ids_weeks18_to_21 <- get_unique_ids(df.original, 18:21)

# Get the consistent sample
consistent_sample_ids <- intersect(ids_week1, ids_week7)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week15)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week16)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week22)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks3_to_6)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks18_to_21)

# Get the number of participants in the consistent sample
num_participants <- length(consistent_sample_ids)
cat("Number of participants in the consistent sample:", num_participants, "\n")

# Filter the original data to include only the consistent sample
df_consistent_sample <- df.original %>%
  filter(record_id %in% consistent_sample_ids)
```

```{r}
# Load required libraries
library(tidyverse)
library(survey)
library(anesrake)
library(mice)
library(ltmle)
library(knitr)
library(kableExtra)
library(ggplot2)
library(ggsci)

# Define function to get unique participant IDs
get_unique_ids <- function(df, weeks) {
  df %>%
    filter(week %in% weeks) %>%
    select(record_id) %>%
    distinct() %>%
    pull(record_id)
}

# Unique IDs for all necessary waves
ids_week1 <- get_unique_ids(df.original, 1)
ids_week7 <- get_unique_ids(df.original, 7)
ids_week15 <- get_unique_ids(df.original, 15)
ids_week16 <- get_unique_ids(df.original, 16)
ids_week22 <- get_unique_ids(df.original, 22)
ids_weeks3_to_6 <- get_unique_ids(df.original, 3:6)
ids_weeks18_to_21 <- get_unique_ids(df.original, 18:21)

# Getting a consistent sample
consistent_sample_ids <- intersect(ids_week1, ids_week7)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week15)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week16)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_week22)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks3_to_6)
consistent_sample_ids <- intersect(consistent_sample_ids, ids_weeks18_to_21)

# Getting the number of participants in the consistent sample
num_participants <- length(consistent_sample_ids)
cat("Number of participants in the consistent sample:", num_participants, "\n")

# Filter the dataset to include only participants from the consistent sample
df_consistent <- df.original %>%
  filter(record_id %in% consistent_sample_ids)

# Create loss.pandemic and loss.nonpandemic variables
df_consistent <- df_consistent %>%
  mutate(loss.pandemic = ifelse(week %in% c(3, 4, 5, 6) & adverse___8 == 1, 1, 0)) %>%
  group_by(record_id) %>%
  mutate(loss.pandemic = max(loss.pandemic)) %>%
  ungroup() %>%
  mutate(loss.nonpandemic = ifelse(week %in% c(18, 19, 20, 21) & adverse___8 == 1, 1, 0)) %>%
  group_by(record_id) %>%
  mutate(loss.nonpandemic = max(loss.nonpandemic)) %>%
  ungroup()

# Create other variables
df_consistent <- df_consistent %>%
  mutate(stressorsminor = rowSums(select(., starts_with("stressorsminor___"))),
         stressorsmajor = rowSums(select(., starts_with("stressorsmajor___"))),
         volunteer = ifelse(acta8 == 0, "No", "Yes"),
         caring = ifelse(acta7 == 0, "No", "Yes"),
         socdistance = ifelse(socdist %in% c(0, 1, 2), "Yes", "No"),
         socisolation = as.numeric(followingisolation),
         smoking = ifelse(smokechange == 3, "More than usual", "As usual or less/don't smoke"),
         drinking = ifelse(alcoholchange == 3, "More than usual", "As usual or less/don't drink"),
         diet = ifelse(dietchange_3 == 1, "Less healthy than usual", "As usual or more healthy"),
         self.harm = ifelse(harm1 == 1, "Not at all", "At least one day"),
         pa.1 = ifelse(actb3 == 0, "No", "Yes"),
         pa.2 = ifelse(actb4 == 0, "No", "Yes"),
         pa.3 = ifelse(actb6 == 0, "No", "Yes"),
         sleep.bin = ifelse(sleep %in% c(1, 2), "Good Sleep", "Average or Poor Sleep")
  ) %>%
  mutate_at(vars(onssat, onshappy, onsworth, socisolation), as.numeric) %>%
  mutate_at(vars(smoking, drinking, diet, self.harm, sleep.bin, pa.1, pa.2, pa.3), as.factor)

df_consistent <- df_consistent %>%
  mutate(illness = rowSums(select(., contains("illness___"))),
         illness = ifelse(illness___11 == 1, 0, illness),
         edu = factor(edu, labels = c("GCSE or below", "A levels or equivalent", "Degree of above")),
         lowincome = factor(lowincome, labels = c("≥£30 000", "<£30 000")),
         socfreq.three = ifelse(socfreq == 1, "Every day", ifelse(socfreq %in% c(2, 3), "Once a week or more often", "Less than once a week")),
         Service.attendance.category = ifelse(religattend <= 2, "At least once a week", ifelse(religattend <= 4, "Less than once a week", "Not at all")),
         Service.attendance.category = factor(Service.attendance.category),
         current.smoking = ifelse(smoker == 1, "Non-smoker", ifelse(smoker == 2, "Ex-smoker", "Current smoker"))
  )

# Create weights
df_wgt <- df_consistent %>%
  filter(week == 1) %>%
  select(record_id, female, country, agegrp4, nonwhite, edu) %>%
  mutate_at(vars(female, country, agegrp4, nonwhite, edu), as.integer) %>%
  mutate_at(vars(female, nonwhite), function(x) x + 1) %>%
  as.data.frame()

df_wgt$caseid <- 1:nrow(df_wgt)

female_target <- c(0.494, 0.506)
country_target <- c(0.843, 0.047, 0.082, 0.028)
agegrp4_target <- c(0.195, 0.261, 0.241, 0.303)
nonwhite_target <- c(0.872, 0.128)
edu_target <- c(0.327, 0.339, 0.334)

targets <- list(female_target, country_target, agegrp4_target, nonwhite_target, edu_target)
names(targets) <- c("female", "country", "agegrp4", "nonwhite", "edu")

raked_output <- anesrake(targets, df_wgt, caseid = df_wgt$caseid)

df_wgt$wgt <- raked_output$weightvec
df_wgt <- df_wgt %>%
  select(record_id, wgt)

# Standardize function
scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

# Define TMLE functions
extract.estimates.ltmle <- function(model.output.TMLE){
  output.TMLE <- summary(model.output.TMLE)
  output.TMLE <- output.TMLE$effect.measures
  ATE.TMLE    <- output.TMLE$ATE %>% as.data.frame()
  return(ATE.TMLE)
}

extract.estimates.ltmle.binary <- function(model.output.TMLE){
  output.TMLE <- summary(model.output.TMLE)
  output.TMLE <- output.TMLE$effect.measures
  RR.TMLE     <- output.TMLE$RR %>% as.data.frame()
  return(RR.TMLE)
}

perform.TMLE <- function(outcome.name,sample.num){
  outcome <- paste(outcome.name, "_7",sep="")  # change week of outcome assessment if needed
  data = df.imputed.long %>%
    filter(sample == sample.num) %>%
    mutate(Yvar = (!!as.name(outcome)))
  
  output = data %>%
    group_nest(.imp) %>%
    mutate(data = map(data, function(x) x %>% select(PHQ_1, GAD_1, stressorsmajor_1, stressorsminor_1, onssat_1, onsworth_1, support_1, lonely_1, smoking_1, drinking_1, sleep.bin_1, volunteer_1, caring_1, pa.1_1, pa.2_1, pa.3_1, Service.attendance.category, age, female, nonwhite, alone , edu, employed, keyworker, lowincome, illness, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c,loss.pandemic,Yvar)),
           fit = map(data, function(x)  x %>%  ltmle(Anodes = "loss.pandemic",Ynodes = "Yvar",abar = list(1,0),observation.weights = x$wgt)),
           estimate = map(fit, function(x) extract.estimates.ltmle(x))) 
  
  output = output %>%
    select(.imp,estimate) %>%
    unnest(estimate) %>%
    mutate(variance = std.dev^2) %>%
    summarise(estimate.combined = mean(estimate),
              Vw = sum(variance)/m,
              Vb = sum((estimate - mean(estimate))^2/(m-1)),
              Vt = Vw + (1 + 1/m)*Vb,
              SE.combined = sqrt(Vt),
              vm = (m-1)*(1 + (Vw/((1+1/m)*Vb)))^2,
              ci.low = estimate.combined - qt(0.975, vm)*SE.combined,
              ci.up = estimate.combined + qt(0.975, vm)*SE.combined,
              p.value = pt(-abs(estimate.combined/SE.combined),vm)*2
    ) %>%
    mutate_if(is.numeric,round,3) %>%
    mutate(outcome = outcome.name) %>%
    select(outcome,estimate.combined,SE.combined, ci.low, ci.up, p.value)   
  
  return(output)
}

perform.TMLE.binary <- function(outcome.name,sample.num){
  outcome <- paste(outcome.name, "_7",sep="")  # change week of outcome assessment if needed
  data = df.imputed.long %>%
    filter(sample == sample.num) %>%
    mutate(Yvar = (!!as.name(outcome)))
  
  output = data %>%
    group_nest(.imp) %>%
    mutate(data = map(data, function(x) x %>% select(PHQ_1, GAD_1, stressorsmajor_1, stressorsminor_1, onssat_1, onsworth_1, support_1, lonely_1, smoking_1, drinking_1, sleep.bin_1, volunteer_1, caring_1, pa.1_1, pa.2_1, pa.3_1, Service.attendance.category, age, female, nonwhite, alone , edu, employed, keyworker, lowincome, illness, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c,loss.pandemic,Yvar)),
           fit = map(data, function(x)  x %>%  ltmle(Anodes = "loss.pandemic",Ynodes = "Yvar",abar = list(1,0),observation.weights = x$wgt)),
           estimate = map(fit, function(x) extract.estimates.ltmle.binary(x))) 
  
  output = output %>%
    select(.imp,estimate) %>%
    unnest(estimate) %>%
    mutate(variance = std.dev^2) %>%
    summarise(estimate.combined = mean(estimate),
              Vw = sum(variance)/m,
              Vb = sum((log(estimate) - mean(log(estimate)))^2/(m-1)),
              Vt = Vw + (1 + 1/m)*Vb,
              SE.combined = sqrt(Vt),
              vm = (m-1)*(1 + (Vw/((1+1/m)*Vb)))^2,
              ci.low = exp(log(estimate.combined) - qt(0.975, vm)*SE.combined),
              ci.up = exp(log(estimate.combined) + qt(0.975, vm)*SE.combined),
              p.value = pt(-abs(log(estimate.combined)/SE.combined),vm)*2
    ) %>%
    mutate_if(is.numeric,round,4) %>%
    mutate(outcome = outcome.name) %>%
    select(outcome,estimate.combined,SE.combined, ci.low, ci.up, p.value)   
  
  return(output)
}

# Create short-term lockdown data
df_short_term_lockdown <- df_consistent %>%
  filter(week %in% c(1, 7)) %>%
  select(record_id, week, PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3) %>%
  mutate(smoking = ifelse(smoking == "As usual or less/don't smoke", 1, 0),
         drinking = ifelse(drinking == "As usual or less/don't drink", 1, 0),
         diet = ifelse(diet == "As usual or more healthy", 1, 0),
         self.harm = ifelse(self.harm == "Not at all", 0, 1),
         sleep.bin = ifelse(sleep.bin == "Good Sleep", 1, 0),
         volunteer = ifelse(volunteer == "Yes", 1, 0),
         caring = ifelse(caring == "Yes", 1, 0),
         pa.1 = ifelse(pa.1 == "Yes", 1, 0),
         pa.2 = ifelse(pa.2 == "Yes", 1, 0),
         pa.3 = ifelse(pa.3 == "Yes", 1, 0)) %>%
  distinct_at(vars(record_id, week), .keep_all = TRUE)

# Standardize continuous outcomes
df_short_term_lockdown <- df_short_term_lockdown %>%
  mutate_at(vars(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, socisolation), scale2) %>%
  pivot_wider(names_from = week, values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3))

df_short_term_lockdown_cov <- df_consistent %>%
  filter(week == 1) %>%
  select(record_id, loss.pandemic, age, female, nonwhite, alone, edu, employed, keyworker, lowincome, illness, Service.attendance.category, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c) %>%
  mutate_if(is.character, as.factor)

df_short_term_lockdown <- df_short_term_lockdown %>%
  left_join(df_short_term_lockdown_cov) %>%
  left_join(df_wgt)

# Perform TMLE for each outcome
output_short_term_lockdown <- rbind(
  perform.TMLE(outcome = "onssat", 1),
  perform.TMLE(outcome = "onshappy", 1),
  perform.TMLE(outcome = "onsworth", 1),
  perform.TMLE(outcome = "support", 1),
  perform.TMLE(outcome = "lonely", 1),
  perform.TMLE.binary(outcome = "volunteer", 1),
  perform.TMLE.binary(outcome = "caring", 1),
  perform.TMLE(outcome = "socisolation", 1),
  perform.TMLE(outcome = "PHQ", 1),
  perform.TMLE(outcome = "GAD", 1),
  perform.TMLE(outcome = "stressorsminor", 1),
  perform.TMLE(outcome = "stressorsmajor", 1),
  perform.TMLE.binary(outcome = "self.harm", 1),
  perform.TMLE.binary(outcome = "smoking", 1),
  perform.TMLE.binary(outcome = "drinking", 1),
  perform.TMLE.binary(outcome = "diet", 1),
  perform.TMLE.binary(outcome = "pa.1", 1),
  perform.TMLE.binary(outcome = "pa.2", 1),
  perform.TMLE.binary(outcome = "pa.3", 1),
  perform.TMLE.binary(outcome = "sleep.bin", 1)
)

output_short_term_lockdown <- output_short_term_lockdown %>%
  select(-SE.combined) %>%
  mutate(sig = ifelse(p.value * 20 < 0.05, "***", ifelse(p.value < 0.01, "**", ifelse(p.value < 0.05, "*.", "N.S."))))

output_short_term_lockdown %>%
  rename(Outcome = outcome, Estimate = estimate.combined, CI.low = ci.low, CI.up = ci.up) %>%
  knitr::kable() %>%
  kableExtra::kable_paper("hover", html_font = "serif", full_width = F)

# Short-term effect post-lockdown
df_short_term_post_lockdown <- df_consistent %>%
  filter(week %in% c(16, 22)) %>%
  select(record_id, week, PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3) %>%
  mutate(smoking = ifelse(smoking == "As usual or less/don't smoke", 1, 0),
         drinking = ifelse(drinking == "As usual or less/don't drink", 1, 0),
         diet = ifelse(diet == "As usual or more healthy", 1, 0),
         self.harm = ifelse(self.harm == "Not at all", 0, 1),
         sleep.bin = ifelse(sleep.bin == "Good Sleep", 1, 0),
         volunteer = ifelse(volunteer == "Yes", 1, 0),
         caring = ifelse(caring == "Yes", 1, 0),
         pa.1 = ifelse(pa.1 == "Yes", 1, 0),
         pa.2 = ifelse(pa.2 == "Yes", 1, 0),
         pa.3 = ifelse(pa.3 == "Yes", 1, 0)) %>%
  distinct_at(vars(record_id, week), .keep_all = TRUE)

# Standardize continuous outcomes
df_short_term_post_lockdown <- df_short_term_post_lockdown %>%
  mutate_at(vars(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, socisolation), scale2) %>%
  mutate(week = ifelse(week == 16, 1, 7)) %>%
  pivot_wider(names_from = week, values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3))

df_short_term_post_lockdown_cov <- df_consistent %>%
  filter(week == 16) %>%
  select(record_id, loss.nonpandemic, age, female, nonwhite, alone, edu, employed, keyworker, lowincome, illness, Service.attendance.category, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c) %>%
  mutate_if(is.character, as.factor)

df_short_term_post_lockdown <- df_short_term_post_lockdown %>%
  left_join(df_short_term_post_lockdown_cov) %>%
  left_join(df_wgt)

# Perform TMLE for each outcome
output_short_term_post_lockdown <- rbind(
  perform.TMLE(outcome = "onssat", 2),
  perform.TMLE(outcome = "onshappy", 2),
  perform.TMLE(outcome = "onsworth", 2),
  perform.TMLE(outcome = "support", 2),
  perform.TMLE(outcome = "lonely", 2),
  perform.TMLE.binary(outcome = "volunteer", 2),
  perform.TMLE.binary(outcome = "caring", 2),
  perform.TMLE(outcome = "socisolation", 2),
  perform.TMLE(outcome = "PHQ", 2),
  perform.TMLE(outcome = "GAD", 2),
  perform.TMLE(outcome = "stressorsminor", 2),
  perform.TMLE(outcome = "stressorsmajor", 2),
  perform.TMLE.binary(outcome = "self.harm", 2),
  perform.TMLE.binary(outcome = "smoking", 2),
  perform.TMLE.binary(outcome = "drinking", 2),
  perform.TMLE.binary(outcome = "diet", 2),
  perform.TMLE.binary(outcome = "pa.1", 2),
  perform.TMLE.binary(outcome = "pa.2", 2),
  perform.TMLE.binary(outcome = "pa.3", 2),
  perform.TMLE.binary(outcome = "sleep.bin", 2)
)

output_short_term_post_lockdown <- output_short_term_post_lockdown %>%
  select(-SE.combined) %>%
  mutate(sig = ifelse(p.value * 20 < 0.05, "***", ifelse(p.value < 0.01, "**", ifelse(p.value < 0.05, "*.", "N.S."))))

output_short_term_post_lockdown %>%
  rename(Outcome = outcome, Estimate = estimate.combined, CI.low = ci.low, CI.up = ci.up) %>%
  knitr::kable() %>%
  kableExtra::kable_paper("hover", html_font = "serif", full_width = F)

# Medium-term effect
df_medium_term <- df_consistent %>%
  filter(week %in% c(1, 15)) %>%
  select(record_id, week, PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3) %>%
  mutate(smoking = ifelse(smoking == "As usual or less/don't smoke", 1, 0),
         drinking = ifelse(drinking == "As usual or less/don't drink", 1, 0),
         diet = ifelse(diet == "As usual or more healthy", 1, 0),
         self.harm = ifelse(self.harm == "Not at all", 0, 1),
         sleep.bin = ifelse(sleep.bin == "Good Sleep", 1, 0),
         volunteer = ifelse(volunteer == "Yes", 1, 0),
         caring = ifelse(caring == "Yes", 1, 0),
         pa.1 = ifelse(pa.1 == "Yes", 1, 0),
         pa.2 = ifelse(pa.2 == "Yes", 1, 0),
         pa.3 = ifelse(pa.3 == "Yes", 1, 0)) %>%
  distinct_at(vars(record_id, week), .keep_all = TRUE)

# Standardize continuous outcomes
df_medium_term <- df_medium_term %>%
  mutate_at(vars(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, socisolation), scale2) %>%
  mutate(week = ifelse(week == 15, 7, 1)) %>%
  pivot_wider(names_from = week, values_from = c(PHQ, GAD, stressorsminor, stressorsmajor, onssat, onshappy, onsworth, support, lonely, smoking, drinking, diet, self.harm, sleep.bin, socisolation, volunteer, caring, pa.1, pa.2, pa.3))

df_medium_term_cov <- df_consistent %>%
  filter(week == 1) %>%
  select(record_id, loss.pandemic, age, female, nonwhite, alone, edu, employed, keyworker, lowincome, illness, Service.attendance.category, current.smoking, alcohol, socfreq.three, closefriends, BFI_n, BFI_e, BFI_o, BFI_a, BFI_c) %>%
  mutate_if(is.character, as.factor)

df_medium_term <- df_medium_term %>%
  left_join(df_medium_term_cov) %>%
  left_join(df_wgt)

# Perform TMLE for each outcome
output_medium_term <- rbind(
  perform.TMLE(outcome = "onssat", 3),
  perform.TMLE(outcome = "onshappy", 3),
  perform.TMLE(outcome = "onsworth", 3),
  perform.TMLE(outcome = "support", 3),
  perform.TMLE(outcome = "lonely", 3),
  perform.TMLE.binary(outcome = "volunteer", 3),
  perform.TMLE.binary(outcome = "caring", 3),
  perform.TMLE(outcome = "socisolation", 3),
  perform.TMLE(outcome = "PHQ", 3),
  perform.TMLE(outcome = "GAD", 3),
  perform.TMLE(outcome = "stressorsminor", 3),
  perform.TMLE(outcome = "stressorsmajor", 3),
  perform.TMLE.binary(outcome = "self.harm", 3),
  perform.TMLE.binary(outcome = "smoking", 3),
  perform.TMLE.binary(outcome = "drinking", 3),
  perform.TMLE.binary(outcome = "diet", 3),
  perform.TMLE.binary(outcome = "pa.1", 3),
  perform.TMLE.binary(outcome = "pa.2", 3),
  perform.TMLE.binary(outcome = "pa.3", 3),
  perform.TMLE.binary(outcome = "sleep.bin", 3)
)

output_medium_term <- output_medium_term %>%
  select(-SE.combined) %>%
  mutate(sig = ifelse(p.value * 20 < 0.05, "***", ifelse(p.value < 0.01, "**", ifelse(p.value < 0.05, "*.", "N.S."))))

output_medium_term %>%
  rename(Outcome = outcome, Estimate = estimate.combined, CI.low = ci.low, CI.up = ci.up) %>%
  knitr::kable() %>%
  kableExtra::kable_paper("hover", html_font = "serif", full_width = F)

# Compile results
output_combined <- rbind(
  output_short_term_lockdown %>% mutate(analysis = "Primary"),
  output_short_term_post_lockdown %>% mutate(analysis = "Post-lockdown"),
  output_medium_term %>% mutate(analysis = "Mid-term")
)

# Print the dataframe to check the structure
print(head(output_combined))

# Continuous outcomes plot
continuous_plot <- output_combined %>%
  filter(outcome %in% con.outcomes) %>%
  ggplot(aes(x = outcome, y = estimate.combined, ymin = ci.low, ymax = ci.up, shape = analysis, color = analysis)) +
  geom_pointrange(position = position_dodge(-0.6)) +
  coord_flip() +
  ggsci::scale_color_nejm() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme_classic()

# Print continuous outcomes plot
print(continuous_plot)

# Binary outcomes plot
binary_plot <- output_combined %>%
  filter(!(outcome %in% con.outcomes)) %>%
  ggplot(aes(x = outcome, y = estimate.combined, ymin = ci.low, ymax = ci.up, shape = analysis, color = analysis)) +
  geom_pointrange(position = position_dodge(-0.6)) +
  coord_flip() +
  ggsci::scale_color_nejm() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  theme_classic()

# Print binary outcomes plot
print(binary_plot)

```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```

```         
```
